# Решение задачи "Практика с RabbitMQ"

## Архитектура решения

### Основные компоненты
Решение включает в себя несколько основных компонентов:

1. **REST API сервис**: Этот компонент отвечает за взаимодействие с пользователями. Он принимает запросы от пользователей, отправляет изображения на обработку и возвращает результаты. Этот компонент реализован с использованием Flask.

2. **RabbitMQ брокер сообщений**: RabbitMQ используется для управления заданиями на обработку изображений. REST API сервис отправляет сообщения с изображениями в очередь, а воркеры извлекают и обрабатывают эти сообщения.

3. **Воркеры**: Воркеры являются отдельными процессами, которые обрабатывают сообщения из RabbitMQ. Они выполняют генерацию описания для изображения и сохраняют результат в файл.

### Взаимодействие компонентов
- Пользователь отправляет изображение на REST API сервис с помощью POST-запроса.
- REST API сервис отправляет сообщение с изображением в RabbitMQ очередь `add_image`.
- Воркеры забирают сообщения из очереди `add_image`, обрабатывают изображения и сохраняют результаты в файлах.
- REST API сервис предоставляет пользователю возможность получить описание обработанного изображения по его идентификатору.

## Реализация

### Логика отправки сообщений
- В REST API сервисе логика отправки сообщений в RabbitMQ реализована в методе, обрабатывающем POST-запросы для загрузки изображений. Этот метод отправляет сообщение с изображением в очередь `add_image`.

### Обработка сообщений и сохранение результатов
- Воркеры (компоненты в папке `worker`) забирают сообщения из очереди `add_image`, выполняют генерацию описания для изображений с использованием библиотеки caption.py и сохраняют результаты в файлах в формате `/data/{image_id}.txt`.

### Получение и возврат результатов
- REST API сервис предоставляет методы для получения списка обработанных изображений и их описаний. Этот функционал позволяет пользователям получать результаты обработки.

### Обработка отказов и гарантированная доставка
- Для обработки сетевых отказов и гарантированной доставки сообщений в RabbitMQ, были использованы концепции и техники из туториалов RabbitMQ, такие как publisher confirms. Это обеспечивает надежную доставку сообщений, даже при возможных сбоях в сети.

## Тестирование

Тесты для проверки различных аспектов нашего решения:
- `test_post_image`: Проверяет отправку изображения на сервер и обработку его воркерами.
- `test_get_image`: Проверяет получение описания обработанного изображения.
- `test_get_image_error`: Проверяет, что получение несуществующего изображения возвращает код 404.
- `test_unique_ids`: Убеждается в уникальности идентификаторов изображений.
- `test_captions_generated_on_workers`: Проверяет, что воркеры генерируют описания для изображений.

## Запуск и развертывание

Для запуска решения, необходимо собрать все компоненты и запустить их в Docker-контейнерах, как указано в инструкции. После развертывания, можно запустить тесты для проверки корректности работы.

## Итого

Решение реализует архитектуру, позволяющую пользователям загружать изображения и получать описания к ним, обеспечивая гарантированную доставку сообщений и надежную обработку изображений.